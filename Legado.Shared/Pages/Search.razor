@page "/Search"
@inherits AppComponentBase

<MudCard Elevation="3" Class="h-full">
    <MudCardContent>
        <MudText Typo="Typo.h5" Class="mb-6 font-weight-bold">搜索功能</MudText>

        <div class="d-flex gap-4 mb-8">
            <MudTextField @bind-Value="SearchQuery"
                          Placeholder="请输入搜索关键词"
                          Variant="Variant.Outlined"
                          Adornment="Adornment.End"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Class="flex-1" />
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="DoSearchAsync"
                       EndIcon="@Icons.Material.Filled.Search">
                搜索
            </MudButton>
        </div>

        @if (searchResults.Any())
        {
            <MudText Typo="Typo.body1" Class="mb-4">搜索结果：</MudText>
            <MudGrid Spacing="3">
                @foreach (var result in searchResults)
                {
                    <MudItem xs="12" sm="6" md="4">
                        <MudPaper Elevation="1" Class="p-3 h-full">
                            <MudCard>
                                <MudCardContent>
                                    <!-- 显示书籍名称 -->
                                    <MudText Typo="Typo.h6" Class="font-weight-bold mb-1">@result.Name</MudText>
                                    
                                    <!-- 显示作者信息 -->
                                    <MudText Typo="Typo.body2" Class="text-secondary mb-2">作者：@result.Author</MudText>
                                    
                                    <!-- 显示封面图片（如果有）-->
                                    @if (!string.IsNullOrEmpty(result.CoverUrl))
                                    {
                                        <MudImage Src="@result.CoverUrl" Height="200" Class="mb-3 object-cover" />
                                    }
                                    
                                    <!-- 显示简介（如果有）-->
                                    @if (!string.IsNullOrEmpty(result.Intro))
                                    {
                                        <MudText Typo="Typo.body2" Class="mb-3 line-clamp-3">简介：@result.Intro</MudText>
                                    }
                                    
                                    <!-- 显示其他信息 -->
                                    @if (!string.IsNullOrEmpty(result.Kind))
                                    {
                                        <MudText Typo="Typo.caption" Class="text-secondary">@result.Kind</MudText>
                                    }
                                    
                                    <!-- 操作按钮 -->
                                    <div class="mt-3 d-flex justify-end">
                                        <MudButton Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined"
                                                   OnClick="() => ViewBookDetail(result)">
                                            查看详情
                                        </MudButton>
                                    </div>
                                </MudCardContent>
                            </MudCard>
                        </MudPaper>
                    </MudItem>
                }
            </MudGrid>
        }
        else if (hasSearched)
        {
            <MudAlert Severity="Severity.Info" Elevation="0">未找到相关结果</MudAlert>
        }
    </MudCardContent>
</MudCard>

@code {
    private string SearchQuery { get; set; } = "诡秘之主";
    private List<SearchBook> searchResults = new();
    private bool hasSearched = false;

    private async Task DoSearchAsync()
    {
        hasSearched = true;
        searchResults.Clear();

        if (string.IsNullOrEmpty(SearchQuery))
        {
            return;
        }

        try
        {
            var result = await LegadoContext.WB.SearchBookAwait(LegadoContext.BookSources[6], SearchQuery);
            if (result?.Count > 0)
            {
                searchResults.AddRange(result);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"搜索失败: {ex.Message}", Severity.Error);
        }
    }
    
    private void ViewBookDetail(dynamic book)
    {
        // 这里可以实现查看书籍详情的逻辑
        Snackbar.Add($"查看: {book.name}", Severity.Info);
        // 可以导航到详情页面或打开对话框等
    }
}