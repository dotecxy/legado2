@page "/Audio/{Pos}"
@using System.Threading
@inherits AppComponentBase
@implements IDisposable

<div class="audio-page">
    <TopCompoent PageTitle="音频播放" />

    <div class="audio-content">
        <!-- 封面和信息 -->
        <div class="cover-section">
            <div class="cover-wrapper">
                @if (!string.IsNullOrEmpty(LegadoContext.CurrentBook?.CoverUrl))
                {
                    <MudImage Src="@LegadoContext.CurrentBook.CoverUrl"
                              Alt="Book Cover"
                              Class="book-cover"
                              ObjectFit="ObjectFit.Cover" />
                }
                else
                {
                    <div class="cover-placeholder">
                        <MudText Typo="Typo.h3">@GetCoverPlaceholder()</MudText>
                    </div>
                }
            </div>
            <MudText Class="book-title">@(LegadoContext.CurrentBook?.Name ?? "未知书籍")</MudText>
            <MudText Class="book-author">@(LegadoContext.CurrentBook?.Author ?? "未知作者")</MudText>
            <MudText Class="chapter-title">@GetCurrentChapterTitle()</MudText>
        </div>

        <!-- 播放控制区 -->
        <div class="player-section">
            <!-- 进度条 -->
            <div class="progress-section">
                <div class="time-display">
                    <MudText Class="time-text">@FormatTime(LegadoContext.ReadPosition)</MudText>
                    <MudText Class="time-text">/</MudText>
                    <MudText Class="time-text">@FormatTime(LegadoContext.ReadTotal)</MudText>
                </div>
                <MudSlider T="double"
                           Value="@LegadoContext.ReadPosition"
                           ValueChanged="OnSeek"
                           Min="0"
                           Max="@Math.Max(LegadoContext.ReadTotal, 1)"
                           Step="1"
                           Class="progress-slider" />
            </div>

            <!-- 播放按钮 -->
            <div class="control-buttons">
                <MudIconButton Icon="@Icons.Material.Filled.SkipPrevious"
                               Color="Color.Primary"
                               Size="Size.Large"
                               OnClick="PreviousChapter" />
                <MudIconButton Icon="@(LegadoContext.IsPlaying? Icons.Material.Filled.PauseCircle : Icons.Material.Filled.PlayCircle)"
                               Color="Color.Primary"
                               Size="Size.Large"
                               Class="play-button"
                               OnClick="TogglePlay" />
                <MudIconButton Icon="@Icons.Material.Filled.SkipNext"
                               Color="Color.Primary"
                               Size="Size.Large"
                               OnClick="NextChapter" />
            </div>

            <!-- 音量控制 -->
            <div class="volume-section">
                <MudIconButton Icon="@GetVolumeIcon()"
                               Color="Color.Default"
                               Size="Size.Small"
                               OnClick="ToggleMute" />
                <MudSlider T="int"
                           Value="@LegadoContext.Volume"
                           ValueChanged="OnVolumeChange"
                           Min="0"
                           Max="100"
                           Step="1"
                           Class="volume-slider" />
                <MudText Class="volume-text">@LegadoContext.Volume%</MudText>
            </div>
        </div>

        <!-- 底部操作 -->
        <div class="action-section">
            <MudButton Color="Color.Primary"
                       Variant="Variant.Outlined"
                       StartIcon="@Icons.Material.Filled.List"
                       OnClick="() => OpenDrawer(0)"
                       Class="action-btn">
                目录
            </MudButton>
            <MudButton Color="Color.Primary"
                       Variant="Variant.Outlined"
                       StartIcon="@Icons.Material.Filled.Settings"
                       OnClick="() => OpenDrawer(1)"
                       Class="action-btn">
                设置
            </MudButton>
        </div>
    </div>

    @if (drawerOpen)
    {
        <!-- 抽屉窗口 -->
        <MudDrawer @bind-Open="@drawerOpen"
                   Anchor="Anchor.Bottom"
                   Elevation="3"
                   Variant="@DrawerVariant.Temporary"
                   Class="drawer-panel">
            <div class="drawer-content">
                <div class="drawer-header">
                    <MudText Typo="Typo.h6">@(drawerTab == 0 ? "章节列表" : "播放设置")</MudText>
                    <MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="CloseDrawer" />
                </div>

                @if (drawerTab == 0)
                {
                    <!-- 章节列表 -->
                    <MudList T="BookChapter" Dense="true" Class="chapter-drawer-list">
                        @if (chapterList != null && chapterList.Count > 0)
                        {
                            @foreach (var chapter in chapterList)
                            {
                                <MudListItem T="BookChapter"
                                             Class="@(chapter.Index == LegadoContext.CurrentChapter.Index ? "active-chapter" : "")"
                                             OnClick="() => NavigateToChapter(chapter)">
                                    <div class="chapter-drawer-item">
                                        <span class="chapter-index">@chapter.Index</span>
                                        <span class="chapter-name">@chapter.Title</span>
                                        @if (chapter.IsVip)
                                        {
                                            <MudChip T="string" Color="Color.Warning" Size="Size.Small">VIP</MudChip>
                                        }
                                    </div>
                                </MudListItem>
                            }
                        }
                        else
                        {
                            <MudListItem T="BookChapter">
                                <MudText Class="text-secondary">暂无章节列表</MudText>
                            </MudListItem>
                        }
                    </MudList>
                }
                else
                {
                    <!-- 播放设置 -->
                    <div class="settings-content">
                        <div class="setting-item">
                            <MudText Class="setting-label">播放速度</MudText>
                            <div class="speed-control">
                                <MudSlider T="double"
                                           Value="@LegadoContext.PlaybackSpeed"
                                           ValueChanged="OnSpeedChange"
                                           Min="0.5"
                                           Max="2.0"
                                           Step="0.1" />
                                <MudText Class="speed-value">@LegadoContext.PlaybackSpeed.ToString("F1")x</MudText>
                            </div>
                        </div>
                        <div class="setting-item">
                            <MudSwitch T="bool" @bind-Value="LegadoContext.AutoPlayNext" Label="自动播放下一章" Color="Color.Primary" />
                        </div>
                        <div class="setting-item">
                            <MudSwitch T="bool" @bind-Value="LegadoContext.RememberPosition" Label="记住播放位置" Color="Color.Primary" />
                        </div>
                    </div>
                }
            </div>
        </MudDrawer>
    }
</div>

<style>
    .audio-page {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
        overflow: hidden;
        background: var(--mud-palette-background);
    }

    .audio-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        padding: 8px 12px;
    }

        .audio-content::-webkit-scrollbar {
            display: none;
        }

    /* 封面区域 */
    .cover-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 8px 0;
    }

    .cover-wrapper {
        width: 120px;
        height: 160px;
        border-radius: 6px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .book-cover {
        width: 100%;
        height: 100%;
    }

    .cover-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--mud-palette-primary) 0%, var(--mud-palette-primary-darken) 100%);
        color: white;
    }

    .book-title {
        margin-top: 8px;
        font-size: 15px;
        font-weight: 600;
        text-align: center;
        max-width: 90%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .book-author {
        font-size: 12px;
        color: var(--mud-palette-text-secondary);
        margin-top: 2px;
    }

    .chapter-title {
        font-size: 11px;
        color: var(--mud-palette-text-secondary);
        margin-top: 4px;
        text-align: center;
        max-width: 85%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* 播放控制区 */
    .player-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding: 8px 0;
        min-height: 0;
    }

    .progress-section {
        padding: 0 4px;
    }

    .time-display {
        display: flex;
        justify-content: center;
        gap: 4px;
        margin-bottom: 2px;
    }

    .time-text {
        font-size: 11px;
        color: var(--mud-palette-text-secondary);
    }

    .progress-slider {
        width: 100%;
    }

    .control-buttons {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        padding: 8px 0;
    }

    .play-button {
        transform: scale(1.6);
    }

    .volume-section {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 4px 12px;
    }

    .volume-slider {
        width: 100px;
    }

    .volume-text {
        font-size: 11px;
        min-width: 32px;
        color: var(--mud-palette-text-secondary);
    }

    /* 底部操作 */
    .action-section {
        display: flex;
        justify-content: center;
        gap: 10px;
        padding: 8px 12px;
        border-top: 1px solid var(--mud-palette-lines-default);
    }

    .action-btn {
        flex: 1;
        max-width: 140px;
        height: 36px;
    }

    /* 抽屉 */
    .drawer-panel {
        height: 55vh !important;
        border-radius: 12px 12px 0 0;
    }

    .drawer-content {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .drawer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        border-bottom: 1px solid var(--mud-palette-lines-default);
    }

    .chapter-drawer-list {
        flex: 1;
        overflow-y: auto;
        padding: 0 !important;
    }

    .chapter-drawer-item {
        display: flex;
        align-items: center;
        gap: 6px;
        width: 100%;
    }

        .chapter-drawer-item .chapter-index {
            min-width: 28px;
            font-size: 10px;
            color: var(--mud-palette-text-secondary);
        }

        .chapter-drawer-item .chapter-name {
            flex: 1;
            font-size: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

    .active-chapter {
        background: var(--mud-palette-primary-lighten) !important;
        color: var(--mud-palette-primary) !important;
    }

    .settings-content {
        padding: 12px;
    }

    .setting-item {
        margin-bottom: 12px;
    }

    .setting-label {
        font-size: 13px;
        margin-bottom: 6px;
    }

    .speed-control {
        display: flex;
        align-items: center;
        gap: 10px;
    }

        .speed-control .mud-slider {
            flex: 1;
        }

    .speed-value {
        font-size: 13px;
        min-width: 36px;
        text-align: center;
    }

    /* 响应式布局 */
    @@media (min-width: 500px) {
        .audio-content {
            max-width: 400px;
            margin: 0 auto;
            padding: 12px 16px;
        }

        .cover-wrapper {
            width: 150px;
            height: 200px;
        }

        .volume-slider {
            width: 140px;
        }
    }

    @@media (max-height: 600px) {
        .cover-wrapper {
            width: 100px;
            height: 140px;
        }

        .cover-section {
            padding: 4px 0;
        }

        .player-section {
            padding: 4px 0;
        }

        .control-buttons {
            padding: 4px 0;
        }

        .book-title {
            font-size: 14px;
            margin-top: 4px;
        }
    }
</style>

@code {
    [Parameter] public string Pos { get; set; }

    // 章节信息
    private List<BookChapter> chapterList = new List<BookChapter>();

    // 抽屉状态
    private bool drawerOpen = false;
    private int drawerTab = 0;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadChapterList();

        // 初始化音频服务（如果还没有初始化）
        LegadoContext.InitializeAudioService(AudioService);

        // 订阅属性变化以更新UI
        LegadoContext.PropertyChanged += OnContextPropertyChanged;

        if (!LegadoContext.IsPlaying && LegadoContext.CurrentChapter != null)
        {
            await LegadoContext.NavigateToChapterAsync(LegadoContext.CurrentChapter);
        }
    }

    /// <summary>
    /// 属性变化时更新UI
    /// </summary>
    private void OnContextPropertyChanged(object sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    /// <summary>
    /// 获取封面占位符（书名第一个字符）
    /// </summary>
    private string GetCoverPlaceholder()
    {
        var name = LegadoContext.CurrentBook?.Name;
        return !string.IsNullOrEmpty(name) ? name[0].ToString() : "?";
    }

    /// <summary>
    /// 获取当前章节标题
    /// </summary>
    private string GetCurrentChapterTitle()
    {
        return LegadoContext.CurrentChapter?.Title ?? "未选择章节";
    }

    /// <summary>
    /// 获取音量图标
    /// </summary>
    private string GetVolumeIcon()
    {
        if (LegadoContext.Volume == 0 || LegadoContext.IsMuted)
            return Icons.Material.Filled.VolumeMute;
        if (LegadoContext.Volume < 50)
            return Icons.Material.Filled.VolumeDown;
        return Icons.Material.Filled.VolumeUp;
    }

    /// <summary>
    /// 加载章节列表
    /// </summary>
    private async Task LoadChapterList()
    {
        chapterList = await LegadoContext.GetBookChapterListAsync();
        StateHasChanged();
    }

    /// <summary>
    /// 播放/暂停
    /// </summary>
    private async Task TogglePlay()
    {
        await LegadoContext.TogglePlayAsync();
    }

    /// <summary>
    /// 上一章
    /// </summary>
    private async Task PreviousChapter()
    {
        await LegadoContext.PreviousChapterAsync();
    }

    /// <summary>
    /// 下一章
    /// </summary>
    private async Task NextChapter()
    {
        if (!LegadoContext.HasNextChapter)
        {
            // 尝试重新加载章节列表
            await LoadChapterList();
        }
        await LegadoContext.NextChapterAsync();
    }

    /// <summary>
    /// 跳转到指定章节
    /// </summary>
    private async Task NavigateToChapter(BookChapter chapter)
    {
        if (chapter != null)
        {
            CloseDrawer();
            await LegadoContext.NavigateToChapterAsync(chapter);
        }
    }

    /// <summary>
    /// 进度跳转
    /// </summary>
    private async Task OnSeek(double value)
    {
        await LegadoContext.SeekAsync((long)value);
    }

    /// <summary>
    /// 音量变化
    /// </summary>
    private async Task OnVolumeChange(int value)
    {
        await LegadoContext.SetVolumeAsync(value);
    }

    /// <summary>
    /// 切换静音
    /// </summary>
    private async Task ToggleMute()
    {
        await LegadoContext.ToggleMuteAsync();
    }

    /// <summary>
    /// 播放速度变化
    /// </summary>
    private void OnSpeedChange(double value)
    {
        LegadoContext.PlaybackSpeed = value;
        // TODO: 应用到音频服务
    }

    /// <summary>
    /// 格式化时间
    /// </summary>
    private string FormatTime(double seconds)
    {
        return TimeSpan.FromMilliseconds(seconds).ToString(@"mm\:ss");
    }

    // 抽屉操作
    private void OpenDrawer(int tab)
    {
        drawerTab = tab;
        drawerOpen = true;
    }

    private void CloseDrawer()
    {
        drawerOpen = false;
    }

    /// <summary>
    /// 释放资源
    /// </summary>
    public void Dispose()
    {
        LegadoContext.PropertyChanged -= OnContextPropertyChanged;
    }
}