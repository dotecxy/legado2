@page "/"
@inherits AppComponentBase
@using Legado.Core.Helps.Login
@using Legado.Core.Models.AnalyzeRules
@inject WebBook wb;

<div class="page-container">
    <TopCompoent ShowBackButton="false" ></TopCompoent>
    @switch (States.IndexState)
    {
        case IndexState.Bookshelf:
        default:
            <Bookshelf></Bookshelf>
            break;
        case IndexState.Discover:
            <Discover></Discover>
            break;
        case IndexState.User:
            break;
    }

    <!-- 底部导航栏 -->
    <div class="bottom-nav">
        <MudPaper Elevation="4" Class="bottom-nav-paper">
            <div class="nav-buttons">
                <MudButton Variant="Variant.Text"
                           Color="@(States.IndexState== IndexState.Bookshelf ? Color.Primary : Color.Default)"
                           Class="nav-btn"
                           OnClick="@(() => States.IndexState= IndexState.Bookshelf)">
                    <div class="nav-btn-content">
                        <MudIcon Icon="@Icons.Material.Filled.Book" Size="Size.Medium" />
                        <MudText Typo="Typo.caption">书架</MudText>
                    </div>
                </MudButton>

                <MudButton Variant="Variant.Text"
                           Color="@(States.IndexState== IndexState.Discover? Color.Primary : Color.Default)"
                           Class="nav-btn"
                           OnClick="@(() =>States.IndexState= IndexState.Discover)">
                    <div class="nav-btn-content">
                        <MudIcon Icon="@Icons.Material.Filled.Explore" Size="Size.Medium" />
                        <MudText Typo="Typo.caption">发现</MudText>
                    </div>
                </MudButton>

                <MudButton Variant="Variant.Text"
                           Color="@(States.IndexState== IndexState.User ? Color.Primary : Color.Default)"
                           Class="nav-btn"
                           OnClick="@(() => States.IndexState= IndexState.User)">
                    <div class="nav-btn-content">
                        <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Medium" />
                        <MudText Typo="Typo.caption">我的</MudText>
                    </div>
                </MudButton>
            </div>
        </MudPaper>
    </div>
</div>

<style>
    .page-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
        overflow: hidden;
    }

    .page-content {
        flex: 1;
        overflow: hidden;
        padding-bottom: 60px;
    }

    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 100;
    }

    .bottom-nav-paper {
        border-radius: 0;
    }

    .nav-buttons {
        display: flex;
        justify-content: space-around;
        align-items: center;
        height: 56px;
    }

    .nav-btn {
        flex: 1;
        height: 100%;
        border-radius: 0;
        min-width: 0;
    }

    .nav-btn-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 2px;
    }

    @@media (max-width: 600px) {
        .page-content {
            padding: 8px !important;
            padding-bottom: 60px !important;
        }
    }
</style>

@code {
    private List<LoginUI> loginUIs = new List<LoginUI>();
    private BookSource current;
    private int currentTab = 0;

    /// <summary>
    /// 导航到指定页面
    /// </summary>
    private void NavigateTo(string path, int tab)
    {
        currentTab = tab;
        Nav.NavigateTo(path);
    }

    protected override async Task OnInitializedAsync()
    {
        await Task.Delay(1);
        try
        {

            LegadoContext.Load();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"读取文件失败: {ex.Message}", Severity.Error);
        }

        try
        {
            _ = HotKeyService.ApplyAsync();
        }
        catch { }
    }

    private async Task ShowSearchAsync()
    {
        await Task.Delay(1);
        Nav.NavigateTo("/Search");
    }

    private void Test()
    {
        var bs = current = LegadoContext.BookSources[6];
        var list = JsonConvert.DeserializeObject<List<LoginUI>>(bs.LoginUi);
        if (list?.Count > 0)
        {
            loginUIs.AddRange(list);
        }
        Nav.NavigateTo("https://sinsam.com");
    }

    private void Login(LoginUI ui)
    {
        var js = current.LoginUrl;
        AnalyzeUrl url = new AnalyzeUrl(js, source: current);
        Console.WriteLine(url.Url);
        try
        {
            Uri uri = new Uri(url.Url);
        }
        catch
        {
            url.EvalJS(url.Url + "\n" + ui.Action);
        }
    }
}