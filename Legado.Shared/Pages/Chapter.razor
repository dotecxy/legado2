@page "/Chapter"
@inherits AppComponentBase

<MudContainer MaxWidth="MaxWidth.Large" Class="py-4">
    @if (isLoading)
    {
        <MudCard Class="elevation-4">
            <MudCardContent>
                <div class="d-flex justify-center align-items-center py-6">
                    <MudProgressCircular Color="Color.Primary" Size="Size.Large" />
                    <MudText Class="ml-3">加载目录中...</MudText>
                </div>
            </MudCardContent>
        </MudCard>
    }
    else if (chapters == null || chapters.Count == 0)
    {
        <MudCard Class="elevation-4">
            <MudCardContent>
                <div class="d-flex justify-center align-items-center py-6">
                    <MudIcon Icon="mdi-book-open-variant-outline" Size="Size.Large" Color="Color.Dark" />
                    <MudText Class="ml-3" Color="Color.Dark">未找到章节信息</MudText>
                </div>
            </MudCardContent>
        </MudCard>
    }
    else
    {
        <!-- 书籍信息 -->
        <MudCard Class="elevation-4 mb-4">
            <MudCardContent>
                <MudText Typo="Typo.h5" Class="font-weight-bold">@book?.Name</MudText>
                <MudText Typo="Typo.subtitle1" Color="Color.Secondary" Class="mb-2">@book?.Author</MudText>
                <MudText Color="Color.Tertiary" Class="text-sm">共 @chapters.Count 个章节</MudText>
            </MudCardContent>
        </MudCard>

        <!-- 搜索框 -->
        <MudCard Class="elevation-4 mb-4">
            <MudCardContent>
                <MudTextField @bind-Value="searchTerm"
                              Label="搜索章节"
                              Variant="Variant.Outlined"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              Placeholder="输入章节标题关键词..."
                              Clearable="true"
                              Class="w-100"
                              OnBlur="() => OnSearchInput()"
                              OnKeyDown="@OnSearchKeyDown"
                              Margin="Margin.Dense">
                </MudTextField>

            </MudCardContent>
        </MudCard>

        <!-- 章节列表 -->
        <MudCard Class="elevation-4">
            <MudCardHeader>
                <MudCardTitle>章节目录</MudCardTitle>
                <MudCardActions>
                    <MudIconButton Icon="mdi-chevron-up" Size="Size.Small" OnClick="() => ScrollToTop()" tooltip="回到顶部" />
                    <MudIconButton Icon="mdi-chevron-down" Size="Size.Small" OnClick="() => ScrollToBottom()" tooltip="到底部" />
                </MudCardActions>
            </MudCardHeader>
            <MudCardContent>
                <div id="chapter-list" style="max-height: 600px; overflow-y: auto;">
                    @if (string.IsNullOrEmpty(searchTerm))
                    {
                        @foreach (var chapter in chapters)
                        {
                            if (chapter.IsVolume)
                            {
                                <!-- 卷名 -->
                                <MudPaper Elevation="2" Class="my-2 px-4 py-2 bg-primary-light">
                                    <MudText Typo="Typo.h6" Color="Color.Primary">@chapter.Title</MudText>
                                </MudPaper>
                            }
                            else
                            {
                                <!-- 章节 -->
                                <MudListItem T="object"
                                             Class="py-2"
                                             buttonVariant="Variant.Text"
                                             OnClick="() => NavigateToContent(chapter)">
                                    <MudChip T="object"
                                             Color="Color.Secondary"
                                             Size="Size.Small"
                                             Class="mr-2"
                                             Variant="Variant.Filled">
                                        @chapter.Index
                                    </MudChip>
                                    <MudText Class="flex-grow-1">
                                        @chapter.Title
                                        @if (!string.IsNullOrEmpty(chapter.Tag))
                                        {
                                            <MudChip T="object"
                                                     Color="Color.Warning"
                                                     Size="Size.Small"
                                                     Class="ml-2"
                                                     Variant="Variant.Outlined">
                                                @chapter.Tag
                                            </MudChip>
                                        }
                                    </MudText>
                                    @if (chapter.IsVip)
                                    {
                                        <MudIcon Icon="mdi-crown" Color="Color.Warning" Size="Size.Small" />
                                    }
                                    @if (chapter.IsPay)
                                    {
                                        <MudIcon Icon="mdi-cash" Color="Color.Error" Size="Size.Small" />
                                    }
                                </MudListItem>
                                <MudDivider Class="my-0" />
                            }
                        }
                    }
                    else
                    {
                        @foreach (var chapter in filteredChapters)
                        {
                            if (chapter.IsVolume)
                            {
                                <!-- 卷名 -->
                                <MudPaper Elevation="2" Class="my-2 px-4 py-2 bg-primary-light">
                                    <MudText Typo="Typo.h6" Color="Color.Primary">@chapter.Title</MudText>
                                </MudPaper>
                            }
                            else
                            {
                                <!-- 章节 -->
                                <MudListItem T="object"
                                             Class="py-2"
                                             buttonVariant="Variant.Text"
                                             OnClick="() => NavigateToContent(chapter)">
                                    <MudChip T="object"
                                             Color="Color.Secondary"
                                             Size="Size.Small"
                                             Class="mr-2"
                                             Variant="Variant.Filled">
                                        @chapter.Index
                                    </MudChip>
                                    <MudText Class="flex-grow-1">
                                        @HighlightSearchTerm(chapter.Title, searchTerm)
                                        @if (!string.IsNullOrEmpty(chapter.Tag))
                                        {
                                            <MudChip T="object"
                                                     Color="Color.Warning"
                                                     Size="Size.Small"
                                                     Class="ml-2"
                                                     Variant="Variant.Outlined">
                                                @chapter.Tag
                                            </MudChip>
                                        }
                                    </MudText>
                                    @if (chapter.IsVip)
                                    {
                                        <MudIcon Icon="mdi-crown" Color="Color.Warning" Size="Size.Small" />
                                    }
                                    @if (chapter.IsPay)
                                    {
                                        <MudIcon Icon="mdi-cash" Color="Color.Error" Size="Size.Small" />
                                    }
                                </MudListItem>
                                <MudDivider Class="my-0" />
                            }
                        }
                    }
                </div>
            </MudCardContent>
        </MudCard>
    }
</MudContainer>

@code {
    private Book? book;
    private List<BookChapter>? chapters;
    private List<BookChapter>? filteredChapters;
    private bool isLoading = true;
    private string? searchTerm;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            isLoading = true;
            book = LegadoContext.CurrentBook;
            if (book != null && LegadoContext.CurrentBookSource != null)
            {
                chapters = await LegadoContext.WebBook.GetChapterListAwait(
                    LegadoContext.CurrentBookSource,
                    book
                );
                filteredChapters = chapters?.ToList();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("加载章节列表失败: " + ex.Message, Severity.Error);
            Console.WriteLine(ex);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
        await base.OnInitializedAsync();
    }

    /// <summary>
    /// 搜索输入处理
    /// </summary>
    private void OnSearchInput()
    {
        FilterChapters();
    }

    private void OnSearchKeyDown(  KeyboardEventArgs e)
    {
        if (e.Key.ToLower() == "enter")
        {
            FilterChapters();
        }
    }

    /// <summary>
    /// 过滤章节列表
    /// </summary>
    private void FilterChapters()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            filteredChapters = chapters?.ToList();
        }
        else
        {
            filteredChapters = chapters?.Where(chapter =>
                !chapter.IsVolume &&
                (chapter.Title?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false)
            ).ToList();
        }
        StateHasChanged();
    }

    /// <summary>
    /// 高亮显示搜索关键词
    /// </summary>
    /// <param name="text">原始文本</param>
    /// <param name="searchTerm">搜索关键词</param>
    /// <returns>包含高亮标记的HTML</returns>
    private MarkupString HighlightSearchTerm(string text, string searchTerm)
    {
        if (string.IsNullOrEmpty(text) || string.IsNullOrEmpty(searchTerm))
        {
            return new MarkupString(text ?? string.Empty);
        }

        var startIndex = 0;
        var result = string.Empty;
        var term = searchTerm.ToLowerInvariant();
        var lowerText = text.ToLowerInvariant();

        while (startIndex < text.Length)
        {
            var index = lowerText.IndexOf(term, startIndex, StringComparison.OrdinalIgnoreCase);

            if (index == -1)
            {
                // 没有更多匹配项，添加剩余文本
                result += text.Substring(startIndex);
                break;
            }

            // 添加匹配前的文本
            result += text.Substring(startIndex, index - startIndex);

            // 添加高亮的匹配文本
            result += $"<span class=\"highlight\">{text.Substring(index, term.Length)}</span>";

            startIndex = index + term.Length;
        }

        return new MarkupString(result);
    }

    private void NavigateToContent(BookChapter chapter)
    {
        // 导航到阅读页面，并传递章节信息
        LegadoContext.CurrentChapter = chapter;
        if (LegadoContext.CurrentBook.Type == 1)
        {
            Nav.NavigateTo("/Audio");
        }
        else
        {
            Nav.NavigateTo("/Content");
        }
    }

    private async Task ScrollToTop()
    {
        await JSRuntime.InvokeVoidAsync("scrollToElement", "#chapter-list", 0, 0);
    }

    private async Task ScrollToBottom()
    {
        await JSRuntime.InvokeVoidAsync("scrollToElement", "#chapter-list", 0, 1000000);
    }
}

<style>
    .highlight {
        background-color: #fff2cc;
        padding: 2px 4px;
        border-radius: 3px;
        font-weight: bold;
        color: #d35400;
    }
</style>