@page "/Bookshelf"
@inherits AppComponentBase
@using Legado.Core.Data.Entities

<div class="page-container">

    <MudCardContent>
        <div class="d-flex justify-space-between align-center mb-6">
            <MudText Typo="Typo.h4" Class="font-weight-bold">我的书架</MudText>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="NavigateToSearch">
                添加书籍
            </MudButton>
        </div>

        @if (isLoading)
        {
            <div class="d-flex justify-center py-8">
                <MudProgressCircular Color="Color.Primary" Size="Size.Large" />
            </div>
        }
        else if (bookshelf.Any())
        {
            <div class="bookshelf-list">
                @foreach (var book in bookshelf)
                {
                    <MudPaper Elevation="1" Class="book-item" @onclick="() => ViewBookDetail(book)">
                        <!-- 左侧封面图片 -->
                        <div class="book-item-cover">
                            @if (!string.IsNullOrEmpty(book.CoverUrl) && !failedCovers.Contains(book.BookUrl))
                            {
                                <MudImage Src="@book.CoverUrl"
                                          Class="cover-image"
                                          ObjectFit="ObjectFit.Cover"
                                          @onerror="@(() => OnImageError(book))" />
                            }
                            else
                            {
                                <div class="cover-placeholder">
                                    <span class="cover-text">@GetFirstChar(book.Name)</span>
                                </div>
                            }
                        </div>

                        <!-- 右侧信息区域 -->
                        <div class="book-item-info">
                            <!-- 第一行：标题 -->
                            <MudText Typo="Typo.subtitle1" Class="book-title">@book.Name</MudText>

                            <!-- 第二行：未读章节数 -->
                            <MudText Typo="Typo.body2" Class="book-unread">
                                @GetUnreadInfo(book)
                            </MudText>

                            <!-- 第三行：最新章节 -->
                            @if (!string.IsNullOrEmpty(book.LatestChapterTitle))
                            {
                                <MudText Typo="Typo.caption" Class="book-latest">最新: @book.LatestChapterTitle</MudText>
                            }
                        </div>

                        <!-- 右侧操作按钮 -->
                        <div class="book-item-actions" @onclick:stopPropagation="true">
                            <MudIconButton Icon="@Icons.Material.Filled.MoreVert"
                                           Size="Size.Small"
                                           OnClick="@(() => OpenBookMenu(book))" />
                        </div>
                    </MudPaper>
                }
            </div>
        }
        else
        {
            <div class="d-flex flex-column align-center justify-center py-12">
                <MudIcon Icon="@Icons.Material.Filled.Book" Size="Size.Large" Class="mb-4" />
                <MudText Typo="Typo.h6" Class="mb-2">书架空空如也</MudText>
                <MudText Typo="Typo.body1" Class="text-secondary mb-6">快去添加一些书籍开始阅读吧</MudText>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="NavigateToSearch">
                    搜索书籍
                </MudButton>
            </div>
        }
    </MudCardContent>

    <!-- 右键菜单弹窗 -->
    <MudMenu AnchorOrigin="Origin.TopRight" TransformOrigin="Origin.TopRight">
        <MudMenuItem OnClick="() => RemoveFromBookshelf(currentBook)">移出书架</MudMenuItem>
        <MudMenuItem OnClick="() => RefreshBookInfo(currentBook)">刷新信息</MudMenuItem>
    </MudMenu>
</div>

<style>
    .page-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
        overflow: hidden;
    }

    .page-content {
        flex: 1;
        overflow: hidden;
    }

    .bookshelf-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-height: calc(100vh - 200px);
        overflow-y: auto;
    }

    .book-item {
        display: flex;
        flex-direction: row;
        padding: 12px;
        cursor: pointer;
        transition: background-color 0.2s;
        align-items: center;
    }

        .book-item:hover {
            background-color: rgba(0, 0, 0, 0.04);
        }

    .book-item-cover {
        flex-shrink: 0;
        width: 60px;
        height: 80px;
        margin-right: 12px;
        border-radius: 4px;
        overflow: hidden;
        background-color: #f5f5f5;
    }

    .cover-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .cover-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
    }

    .cover-text {
        font-size: 28px;
        font-weight: bold;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }

    .book-item-info {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 4px;
    }

    .book-title {
        font-weight: 600;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .book-unread {
        color: #1976d2;
        font-size: 13px;
    }

    .book-latest {
        color: #888;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .book-item-actions {
        flex-shrink: 0;
        margin-left: 8px;
    }

    @@media (max-width: 600px) {
        .page-content {
            padding: 8px !important;
        }

        .bookshelf-list {
            max-height: calc(100vh - 200px);
            gap: 8px;
        }

        .book-item {
            padding: 10px;
        }

        .book-item-cover {
            width: 50px;
            height: 68px;
            margin-right: 10px;
        }

        .cover-text {
            font-size: 22px;
        }

        .book-title {
            font-size: 15px;
        }

        .book-unread {
            font-size: 12px;
        }

        .book-latest {
            font-size: 12px;
        }
    }
</style>

@code {
    // 书架中的书籍列表
    private List<Book> bookshelf = new();
    private Book currentBook = null;
    private bool isLoading = true;
    private HashSet<string> failedCovers = new();
    

    /// <summary>
    /// 获取书名第一个字符
    /// </summary>
    private string GetFirstChar(string name)
    {
        if (string.IsNullOrEmpty(name)) return "书";
        return name.Substring(0, 1);
    }

    /// <summary>
    /// 封面图片加载失败处理
    /// </summary>
    private void OnImageError(Book book)
    {
        if (!string.IsNullOrEmpty(book.BookUrl))
        {
            failedCovers.Add(book.BookUrl);
            StateHasChanged();
        }
    }

    /// <summary>
    /// 获取未读章节信息
    /// </summary>
    private string GetUnreadInfo(Book book)
    {
        var totalChapters = book.TotalChapterNum;
        var readChapter = book.DurChapterIndex + 1;

        if (totalChapters <= 0)
        {
            return book.DurChapterIndex >= 0 ? $"已读至第{readChapter}章" : "尚未阅读";
        }

        var unread = totalChapters - readChapter;
        if (unread <= 0)
        {
            return "已读完";
        }
        return $"{unread}章未读";
    }

    /// <summary>
    /// 页面初始化时加载书架数据
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        

        await LoadBookshelfData();
    }

    /// <summary>
    /// 加载书架数据
    /// </summary>
    private async Task LoadBookshelfData()
    {
        try
        {
            isLoading = true;
            // 从LegadoContext获取书架数据
            bookshelf = await LegadoContext.GetBookshelfAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"加载书架失败: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// 导航到搜索页面
    /// </summary>
    private void NavigateToSearch()
    {
        Nav.NavigateTo("/Search");
    }

    /// <summary>
    /// 查看书籍详情
    /// </summary>
    /// <param name="book">要查看的书籍</param>
    private async void ViewBookDetail(Book book)
    {
         LegadoContext.CurrentBook = book;
        _ = await LegadoContext.GetBookChapterListAsync(false);
        LegadoContext.CurrentChapter = LegadoContext.CurrentChapters.ElementAt(book.DurChapterIndex);
        if (book.Type == 1)
        {
            Nav.NavigateTo($"/Audio/{book.DurChapterPos}");
        }
        else
        {
            Nav.NavigateTo("/Content");
        }
    }

    /// <summary>
    /// 开始阅读书籍
    /// </summary>
    /// <param name="book">要阅读的书籍</param>
    private void StartReading(Book book)
    {
        LegadoContext.CurrentBook = book;
        Nav.NavigateTo("/Chapter");
    }

    /// <summary>
    /// 打开书籍菜单
    /// </summary>
    /// <param name="book">目标书籍</param>
    private void OpenBookMenu(Book book)
    {
        currentBook = book;
        // 在实际实现中，这里会打开一个菜单
        // 目前我们只显示一个提示
        Snackbar.Add($"操作菜单: {book.Name}", Severity.Info);
    }

    /// <summary>
    /// 从书架移除书籍
    /// </summary>
    /// <param name="book">要移除的书籍</param>
    private async Task RemoveFromBookshelf(Book book)
    {
        try
        {
            // 从书架中移除书籍
            await LegadoContext.RemoveFromBookshelfAsync(book);
            bookshelf.Remove(book);
            StateHasChanged();
            Snackbar.Add($"已从书架移除: {book.Name}", Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"移除失败: {ex.Message}", Severity.Error);
        }
    }

    /// <summary>
    /// 刷新书籍信息
    /// </summary>
    /// <param name="book">要刷新的书籍</param>
    private async Task RefreshBookInfo(Book book)
    {
        try
        {
            // 刷新书籍信息的逻辑
            // 这里只是一个示例实现
            Snackbar.Add($"正在刷新: {book.Name}", Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"刷新失败: {ex.Message}", Severity.Error);
        }
    }
}